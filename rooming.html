<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador de Reservas - SUTEBA</title>
    <link rel="stylesheet" href="src/styles.css">
    <style>
        /* Estilos espec铆ficos para rooming */
        #btnGuardar {
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #btnGuardar:hover {
            background-color: #218838;
        }

        #resultContainer {
            margin: 20px auto;
            max-width: 1000px;
            text-align: center;
        }

        #resultOutput {
            background-color: #f4f4f4;
            padding: 10px;
            white-space: pre-wrap;
            margin-top: 20px;
            font-size: 20px;
            font-family: Arial, sans-serif;
        }

        .back-button {
            margin: 20px 0;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .back-button:hover {
            background-color: #5a6268;
        }
    </style>
</head>

<body>
    <div class="header-container">
        <div class="logo-initial">
            <img src="assets/suteba_logo_3.jpg" alt="Logo SUTEBA" style="width: 100px;">
        </div>
        <h1 class="h1-initial">Procesador de Reservas Hoteleras</h1>
        <h2 class="h2-initial">Rooming List - Jubilados</h2>
        
        <div style="display: flex; justify-content: center; gap: 15px; margin: 20px 0;">
            <a href="index.html" class="back-button">猬锔 Volver al Men煤</a>
            <button class="upload-button" onclick="handleFileSelect()">
                <span></span> Cargar Archivo CSV
            </button>
        </div>
    </div>
    
	<div id="resultContainer">
	    <h2>Listado de Reservas</h2>
	    <div id="tableOutput"></div>
	    <pre id="statsOutput"></pre>
    	</div>
    <script>
	// --- FUNCIONES PRINCIPALES ---

	function handleFileSelect() {
	    const fileInput = document.createElement('input');
	    fileInput.type = 'file';
	    fileInput.accept = '.csv';
	    fileInput.addEventListener('change', (event) => {
		const file = event.target.files[0];
		const reader = new FileReader();

		reader.onload = () => {
		    const fileContents = reader.result;
		    const resultObject = processData(fileContents); // Devuelve {data, stats, reservations}

		    const tableContainer = document.getElementById('tableOutput');
		    const statsOutput = document.getElementById('statsOutput');
		    
		    // 1. Mostrar Estad铆sticas y Limpiar
		    statsOutput.textContent = resultObject.stats;
		    tableContainer.innerHTML = ''; // Limpiar visualizaci贸n anterior

		    // 2. Construir y Mostrar la Tabla con Datos Ordenados
		    tableContainer.innerHTML = buildHTMLTable(resultObject.reservations);

		    // 3. Crear o Actualizar el Bot贸n de Guardar
		    let downloadButton = document.getElementById('btnGuardar');
		    if (!downloadButton) {
		        downloadButton = document.createElement('button');
		        downloadButton.textContent = 'Guardar como archivo CSV (LibreOffice compatible)';
		        downloadButton.id = 'btnGuardar';
		        // A帽adir el bot贸n al contenedor principal (fuera de la tabla)
		        document.getElementById('resultContainer').appendChild(downloadButton); 
		    }
		    
		    // Asignar la funci贸n de descarga al bot贸n (usa resultObject.data limpia)
		    downloadButton.onclick = () => {
		        const csvDataFinal = addHeadersToCSV(resultObject.data);
		        downloadCSV(csvDataFinal, 'reservas_ingresan.csv');
		    };
		};

		reader.readAsText(file);
	    });

	    fileInput.click();
	}

	function processData(fileContents) {
	    var lines = fileContents.split('\n');
	    var reservations = []; // Array para almacenar objetos de reserva
	    var roomCount = {}; 
	    var peopleCount = 0; 

	    // Omitir el encabezado (i = 1)
	    for (var i = 1; i < lines.length; i++) {
		var line = lines[i].trim();
		if (line === '') continue; 
		
		// Parser CSV con separaci贸n por comas
		var fields = line.split(',');
		
		// Correcci贸n para CSV con comas extras en campo Observaci贸n (columna 4)
		const EXPECTED_FIELDS_COUNT = 28; // N煤mero esperado de campos en el CSV
		if (fields.length > EXPECTED_FIELDS_COUNT) {
		    // Hay campos extras, probablemente por comas en Observaci贸n
		    const extraFields = fields.length - EXPECTED_FIELDS_COUNT;
		    const endObservationIndex = 4 + extraFields;
		    
		    // Recombinar los campos extras como un solo campo Observaci贸n
		    const correctedObservation = fields.slice(4, endObservationIndex + 1).join('; ');
		    
		    // Reconstruir el array con la observaci贸n corregida
		    fields = [
		        ...fields.slice(0, 4),        // Campos 0-3
		        correctedObservation,          // Campo 4 (Observaci贸n corregida)
		        ...fields.slice(endObservationIndex + 1)  // Campos 5 en adelante
		    ];
		}
		
		// Validar que la l铆nea tenga suficientes campos
		if (fields.length < 15) continue; 
		
		// --- EXTRACCIN Y LIMPIEZA DE CAMPOS ---
		// Mapeo correcto de columnas del CSV de entrada:
		// 0: C贸d. Alojamiento
		// 1: Descripci贸n
		// 2: Nro. habitaci贸n
		// 3: Tipo habitaci贸n
		// 4: Observaci贸n habitaci贸n
		// 5: Cantidad plazas
		// 6: Voucher
		// 7: Sede
		// 8: Fecha de ingreso
		// 9: Fecha de egreso
		// 10: Plazas ocupadas
		// 11: Tipo documento
		// 12: Nro. doc.
		// 13: Apellido y nombre
		// 14: Edad
		
		var roomNumber = fields[2].replace(/[^\d]/g, '');
		var din = fields[8];
		var dout = fields[9];
		var dni = fields[12];
		var passengerName = fields[13];
		var age = fields[14];
		
		// --- CREAR OBJETO DE RESERVA ---
		var reservation = {
		    'Nro. habitaci贸n': roomNumber,
		    'Fecha de ingreso': din,
		    'Fecha de egreso': dout,
		    'Cantidad plazas': fields[5],
		    'Tipo documento': fields[11],
		    'Nro. doc.': dni,
		    'Apellido y nombre': passengerName,
		    'Edad': age,
		    'Observaci贸n habitaci贸n': fields[4], // Ahora maneja comas correctamente
		    'Tipo': fields[3] // Tipo habitaci贸n
		};
		reservations.push(reservation);
		
		// --- CONTEO DE ESTADSTICAS ---
		roomCount[roomNumber] = (roomCount[roomNumber] || 0) + 1;
		peopleCount++;
	    }

	    // --- ORDENAMIENTO (Por Habitaci贸n y luego por Nombre) ---
	    reservations.sort((a, b) => {
		// 1. Ordena por Nro. habitaci贸n
		if (a['Nro. habitaci贸n'] < b['Nro. habitaci贸n']) return -1;
		if (a['Nro. habitaci贸n'] > b['Nro. habitaci贸n']) return 1;
		
		// 2. Si la habitaci贸n es la misma, ordena por Apellido y nombre
		if (a['Apellido y nombre'] < b['Apellido y nombre']) return -1;
		if (a['Apellido y nombre'] > b['Apellido y nombre']) return 1;
		
		return 0;
	    });

	    // --- CONVERSIN A STRING CSV (Para la descarga) ---
	    // 隆Usamos punto y coma ( como delimitador para LibreOffice!
	    var csvOutputData = reservations.map(res => {
		return Object.values(res).join(';');
	    }).join('\n');
	    
	    // Generar las estad铆sticas por separado
	    var statsOutput = 
		'Habitaciones que se ocupan: ' + Object.keys(roomCount).length + '\n' +
		'Cantidad de pax: ' + peopleCount + '\n';
		
	    // Devolver el objeto estructurado
	    return {
		data: csvOutputData, // Datos limpios y ordenados (con 
		stats: statsOutput,
		reservations: reservations // Array de objetos ordenados (para la tabla)
	    };
	}


	// --- FUNCIONES AUXILIARES ---

	function buildHTMLTable(reservations) {
	    if (reservations.length === 0) return '<p>No se encontraron reservas.</p>';

	    // Usamos las claves del primer objeto para los encabezados
	    const headers = Object.keys(reservations[0]); 
	    
	    let html = '<table style="width:100%; border-collapse: collapse; margin-top: 15px;">';
	    
	    // Encabezados de la tabla
	    html += '<thead><tr>';
	    headers.forEach(header => {
		html += `<th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2; text-align: left;">${header}</th>`;
	    });
	    html += '</tr></thead>';

	    // Cuerpo de la tabla
	    html += '<tbody>';
	    reservations.forEach(res => {
		html += '<tr>';
		headers.forEach(key => {
		    let cellContent = res[key];
		    // Resaltamos con negrita el Nro. Habitaci贸n y Nombre
		    if (key === 'Nro. habitaci贸n' || key === 'Apellido y nombre') {
		        cellContent = `<b>${cellContent}</b>`;
		    }
		    html += `<td style="border: 1px solid #ddd; padding: 8px;">${cellContent}</td>`;
		});
		html += '</tr>';
	    });
	    html += '</tbody></table>';

	    return html;
	}

	function addHeadersToCSV(csvData) {
	    // Encabezados con punto y coma (;) para compatibilidad con LibreOffice
	    var headers = 'Nro. habitaci贸n;Fecha de ingreso;Fecha de egreso;Cantidad plazas;Tipo documento;Nro. doc.;Apellido y nombre;Edad;Observaci贸n habitaci贸n;Tipo\n';
	    return headers + csvData;
	}

	// Funci贸n de descarga
	function downloadCSV(csv, filename) {
	    var csvFile = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }); // Agregado BOM para mejor compatibilidad

	    if (window.navigator.msSaveBlob) {
		// IE 10+
		window.navigator.msSaveBlob(csvFile, filename);
	    } else {
		// Otros navegadores
		var downloadLink = document.createElement('a');
		downloadLink.href = URL.createObjectURL(csvFile);
		downloadLink.setAttribute('download', filename);
		downloadLink.style.display = 'none'; // Asegurar que no se muestre
		document.body.appendChild(downloadLink);
		downloadLink.click();
		document.body.removeChild(downloadLink);
	    }
	}

	// --- PARSER CSV ROBUSTO ---
	// Esta funci贸n maneja correctamente campos con comas entre comillas
	function parseCSVLine(line) {
	    const fields = [];
	    let field = '';
	    let insideQuotes = false;
	    
	    for (let i = 0; i < line.length; i++) {
		const char = line[i];
		const nextChar = line[i + 1];
		
		if (char === '"') {
		    if (insideQuotes && nextChar === '"') {
		        // Comillas dobles escapadas ""
		        field += '"';
		        i++; // Saltar la siguiente comilla
		    } else {
		        // Alternar estado de dentro/fuera de comillas
		        insideQuotes = !insideQuotes;
		    }
		} else if (char === ',' && !insideQuotes) {
		    // Coma fuera de comillas = separador de campo
		    fields.push(field);
		    field = '';
		} else {
		    field += char;
		}
	    }
	    
	    // A帽adir el 煤ltimo campo
	    fields.push(field);
	    
	    return fields;
	}

    </script>
</body>

</html>

